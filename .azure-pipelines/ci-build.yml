# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
parameters:
  - name: BuildAgent
    default: 1es-windows-ps-compute
    displayName: Build Agent
  - name: Test
    type: boolean
    default: true
  - name: Pack
    type: boolean
    default: true
  - name: Sign
    type: boolean
    default: true

variables:
  BuildAgent: ${{ parameters.BuildAgent }}
  GitUserEmail: 'GraphTooling@service.microsoft.com'
  GitUserName: 'Microsoft Graph DevX Tooling'

pool: $(BuildAgent)

trigger:
  branches:
    include:
      - main
      - features/2.0
pr: none

jobs:
- job: MsGraphPsSdkCiBuild
  displayName: Microsoft Graph PowerShell SDK CI Build
  timeoutInMinutes: 840
  steps:
    - template: ./common-templates/install-tools.yml
    - template: ./common-templates/security-pre-checks.yml

    - template: ./generation-templates/authentication-module.yml
      parameters:
        Test: ${{ parameters.Test }}
        Pack: ${{ parameters.Pack }}
        Sign: ${{ parameters.Sign }}

    - template: ./generation-templates/workload-modules.yml
      parameters:
        Test: ${{ parameters.Test }}
        Pack: ${{ parameters.Pack }}
        Sign: ${{ parameters.Sign }}

    - template: ./generation-templates/meta-module.yml
      parameters:
        Test: ${{ parameters.Test }}
        Pack: ${{ parameters.Pack }}
        Sign: ${{ parameters.Sign }}

    - ${{ if eq(parameters.Sign, true) }}:
      - template: ./common-templates/esrp/codesign-nuget.yml
        parameters:
          FolderPath: '$(Build.ArtifactStagingDirectory)'
          Pattern: 'Microsoft.Graph*.nupkg'

      - task: PublishBuildArtifacts@1
        displayName: Publish Module Artifacts
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'

    - template: ./common-templates/security-post-checks.yml
