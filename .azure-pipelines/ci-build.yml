# azure-pipelines.yml
trigger:
  branches:
    include:
      - task/migrate-acr-push-pipeline
      - main
  paths:
    include:
      - src/**
      - ./azure-pipelines/**
  tags:
    include:
      - v*
 
variables:
  REGISTRY: 'msgraphpperegistry.azurecr.io'
  IMAGE_NAME: 'public/microsoftgraph/powershell'
  PREVIEW_BRANCH: 'refs/heads/task/migrate-acr-push-pipeline'  # Updated to target your branch
  vmImageName: 'ubuntu-latest'
 
 
stages:
- stage: PushToRegistry
  displayName: 'Push docker image'
  jobs:
    - job: PushDockerImage
      displayName: 'Push docker image'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - checkout: self
 
      - task: AzureCLI@2
        displayName: "Log in to Azure Container Registry"
        inputs:
          azureSubscription: 'ACR Push Test' # service connection
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          'inlineScript': |
            az acr login --name $(REGISTRY)
 
      - powershell: |
          $version = $Env:BUILD_SOURCEBRANCH.replace("refs/tags/", "")
          Write-Output "##vso[task.setvariable variable=version]$version"
        displayName: 'Get truncated run number'
 
      - bash: |
          echo "##vso[task.setvariable variable=version]$(version)"
        displayName: 'Set version variable'
 
      - bash: |
          echo "Building docker images"
          docker build \
            -t $(REGISTRY)/$(IMAGE_NAME):latest \
            -t $(REGISTRY)/$(IMAGE_NAME):$(version) \
            "$(Build.SourceDirectory)"
 
          echo "Pushing docker images"
          docker push $(REGISTRY)/$(IMAGE_NAME):latest
          docker push $(REGISTRY)/$(IMAGE_NAME):$(version)
        displayName: 'Build and push docker images'