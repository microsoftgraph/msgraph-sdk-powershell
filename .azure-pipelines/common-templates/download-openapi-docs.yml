# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

parameters:
  - name: Branch
    type: string
    default: "WeeklyApiRefresh"
  - name: BaseBranch
    type: string
  - name: BuildAgent
    displayName: Build Agent

steps:
  - template: ./checkout.yml
    parameters:
      TargetBranch: ${{ parameters.BaseBranch }}

  - template: ./install-tools.yml

  - task: PowerShell@2
    name: "ComputeBranch"
    displayName: "Compute weekly branch name and set Branch variable"
    inputs:
      targetType: inline
      script: |
        $branch = "{0}/{1}" -f "${{ parameters.Branch }}", (Get-Date -Format yyyyMMddHHmm)
        Write-Host "Computed weekly branch: $branch"
        # Set the Branch pipeline variable
        Write-Host "##vso[task.setvariable variable=Branch;isOutput=false]$branch"

  - task: Bash@3
    displayName: "Create weekly branch"
    inputs:
      targetType: inline
      script: |
        git status
        git branch $(Branch)
        git checkout $(Branch)
        git status

  - task: PowerShell@2
    displayName: Download v1.0 OpenApi docs
    continueOnError: false
    inputs:
      filePath: "$(System.DefaultWorkingDirectory)/tools/UpdateOpenApi.ps1"
      pwsh: true

  - task: PowerShell@2
    displayName: Download beta OpenApi docs
    continueOnError: false
    inputs:
      filePath: "$(System.DefaultWorkingDirectory)/tools/UpdateOpenApi.ps1"
      arguments: -BetaGraphVersion
      pwsh: true

  - task: PowerShell@2
    name: OpenAPIDocDiff
    displayName: Get OpenAPI docs diff and set ModuleGenerationList variable
    inputs:
      filePath: "$(System.DefaultWorkingDirectory)/tools/Utilities/OpenApiDocDiff.ps1"
      pwsh: true

  - task: PowerShell@2
    name: BuildOpenApiMetadataDetectionTool
    displayName: Build tool for detecting metadata changes
    inputs:
      pwsh: true
      targetType: inline
      script: dotnet build --configuration Release
      workingDirectory: "$(System.DefaultWorkingDirectory)/tools/OpenApiInfoGenerator/OpenApiInfoGenerator"

  - task: PowerShell@2
    name: GenerateOpenApiErrorAndInfoFiles
    displayName: Generate OpenApi error and info file for detecting unnecessary changes that would lead to a breaking change
    inputs:
      pwsh: true
      targetType: inline
      script: dotnet run
      workingDirectory: "$(System.DefaultWorkingDirectory)/tools/OpenApiInfoGenerator/OpenApiInfoGenerator"

  - task: Bash@3
    displayName: Commit downloaded files
    condition: and(succeeded(), ne(variables['ModuleGenerationList'], ''))
    env:
      GITHUB_TOKEN: $(GITHUB_TOKEN)
    inputs:
      targetType: inline
      script: |
        git status
        git add .
        git commit -m 'Weekly OpenApiDocs Download.'
        git status
        git push --set-upstream "https://$(GITHUB_TOKEN)@github.com/microsoftgraph/msgraph-sdk-powershell.git" $(Branch)
        git status

# References
# [0] https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables
# [1] https://hub.github.com/hub-pull-request.1.html
# https://help.github.com/en/actions/configuring-and-managing-workflows/authenticating-with-the-github_token