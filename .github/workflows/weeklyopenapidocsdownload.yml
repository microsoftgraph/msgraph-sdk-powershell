# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
# This is a basic workflow to help you get started with Actions

name: WeeklyOpenApiDocsDownload
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: 
      - dev
      - gn/generateOpenApiDocs
  schedule:
    - cron: "0 12 * * 5" # Run at Midnight UTC on Friday

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  downloadOpenApiDocs:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - name: Configure User
      run: |
         git config --global user.email "mgpssdk@microsoft.com"
         git config --global user.name "GitHub Worklows"
      
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - name: Checkout
      uses: actions/checkout@v2
      
    - name: List Directory
      run: | 
        echo $GITHUB_WORKSPACE
        ls -lsa $GITHUB_WORKSPACE
        ls -lsa $GITHUB_WORKSPACE/tools
        
    # Runs a single command using the runners shell
    - name: Update v1.0 OpenApiDocs
      id: update_v1
      run: |
        pwsh $GITHUB_WORKSPACE/tools/UpdateOpenApi.ps1
      
    # Runs a single command using the runners shell
    - name: Update beta OpenApiDocs
      id: update_beta
      run: |
        pwsh $GITHUB_WORKSPACE/tools/UpdateOpenApi.ps1 -BetaGraphVersion
    
    - name: Create Branch
      id: create_branch
      shell: pwsh
      run: |
        $branch = "{0}.{1}" -f "weeklyOpenApiDocsDownload", (Get-Date -Format yyyyMMdd)
        git branch $branch
        git checkout $branch
        Write-Host "##[set-output name=branch;]$branch"
        
    - name: Commit Files
      id: commit_files
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: ${{steps.create_branch.outputs.branch}}
      run: |
        cd $GITHUB_WORKSPACE/openApiDocs/
        git add .
        git commit -m 'Weekly OpenApiDocs Download'
        git push --set-upstream origin $BRANCH
        
    # Create a pull request [1]
    - name: Create PR using the GitHub REST API via hub
      shell: bash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MESSAGE_TITLE: Weekly OpenApiDocs Download
        MESSAGE_BODY: "This pull request was automatically created by the GitHub Action,\n\n Contains OpenApiDocs Updates from Graph Explorer API"
        REVIEWERS: finsharp
        ASSIGNEDTO: finsharp
        LABELS: generated
        BASE: dev
        HEAD: ${{steps.create_branch.outputs.branch}}
      run: |
        curl -fsSL https://github.com/github/hub/raw/master/script/get | bash -s 2.14.1
        bin/hub pull-request -b "$BASE" -h "$HEAD" -m "$MESSAGE_TITLE" -m "$MESSAGE_BODY" -r "$REVIEWERS" -a "$ASSIGNEDTO" -l "$LABELS"



# References
# [0] https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables
# [1] https://hub.github.com/hub-pull-request.1.html
# https://help.github.com/en/actions/configuring-and-managing-workflows/authenticating-with-the-github_token